# セルフバランシングバイク プロジェクト

## 概要

このプロジェクトは、MPU6050センサーとPID制御アルゴリズムを使用して自動的にバランスを維持するセルフバランシングバイクです。スマートフォンアプリからのリモート制御にも対応しており、ステアリングと速度を制御できます。

> **元のプロジェクト**: このプロジェクトのArduinoコードは、[remrc/Self-Balancing-Bike](https://github.com/remrc/Self-Balancing-Bike) を基にしています。

## 主な特徴

- **自動バランス制御**: MPU6050センサーと補完フィルタによる高精度な角度検出
- **PID制御**: 角度、角速度、速度、位置を統合した安定した制御システム
- **リモート制御**: スマートフォンアプリ経由でのステアリング・速度制御
- **安全機能**: 動作条件チェック、自動停止、バッテリー電圧監視
- **キャリブレーション機能**: EEPROMへの設定保存と自動読み込み

## プロジェクト構成

```
open source balance bike/
├── 01.Arduino Code and Library/    # Arduinoプログラムとライブラリ
│   ├── self_balancing_bike.ino    # メインプログラム
│   ├── functions.ino              # 関数定義ファイル
│   ├── remote.ino                 # リモート制御処理
│   ├── ServoTimer2-master.zip     # サーボ制御ライブラリ
│   └── how to debug PID.txt       # PIDデバッグ方法
├── 02.APP/                        # Androidアプリケーション
│   └── app.apk                    # リモート制御アプリ
├── 03.3D STL and Solidworks/      # 3Dモデルファイル
│   └── 3D Blance bike.rar        # 3Dモデルデータ
├── 04.SCH/                        # 回路図
│   └── SCH.pdf                    # 回路図PDF
└── README.md                      # このファイル
```

## Arduinoプログラムの構成

このプロジェクトのArduinoプログラムは、以下の3つの`.ino`ファイルで構成されています：

1. **`self_balancing_bike.ino`** - メインプログラム
   - プログラムのエントリーポイント
   - メイン制御ループ（10ms周期）
   - グローバル変数の定義
   - PID制御の実装

2. **`functions.ino`** - 関数定義ファイル
   - MPU6050センサー関連の関数
   - モーター制御関数
   - エンコーダー読み取り関数
   - キャリブレーション関連の関数

3. **`remote.ino`** - リモート制御ファイル
   - シリアル通信からのデータ受信
   - ジョイスティック入力の処理
   - ボタン入力の処理

詳細については、[ファイル間の関係説明書](self_balancing_bike.ino、functions.ino、remote.inoの関係.md)を参照してください。

## 必要なハードウェア

- **Arduino互換ボード**（Arduino Nano推奨）
- **MPU6050** - 6軸IMUセンサー（加速度計・ジャイロ）
- **DCモーター** × 2 - 駆動用モーター
- **モーターエンコーダー** - 速度検出用
- **サーボモーター** × 2 - ステアリング制御用
- **モータードライバー** - PWM制御対応
- **バッテリー** - 電源用
- **ブザー** - 通知用
- **その他**: 抵抗、コンデンサ、配線材など

詳細な回路図は `04.SCH/SCH.pdf` を参照してください。

## 必要なソフトウェア

- **Arduino IDE** 1.8.x以上
- **ServoTimer2ライブラリ** - `01.Arduino Code and Library/ServoTimer2-master.zip`を解凍してインストール
- **Android端末** - リモート制御アプリ用（`02.APP/app.apk`をインストール）

## セットアップ手順

### 1. Arduino IDEのセットアップ

1. Arduino IDEをインストール
2. `ServoTimer2-master.zip`を解凍し、Arduino IDEのライブラリフォルダに配置
3. Arduino IDEで `01.Arduino Code and Library/` フォルダをスケッチとして開く

### 2. ハードウェアの接続

回路図（`04.SCH/SCH.pdf`）に従ってハードウェアを接続してください。

主要なピン接続：
- **モーター1**: PWM_1 (ピン9), DIR_1 (ピン7)
- **モーター2**: PWM_2 (ピン10), DIR_2 (ピン5)
- **エンコーダー**: ENC_1 (ピン2), ENC_2 (ピン3)
- **MPU6050**: I2C接続（SDA, SCL）
- **サーボ**: A3, 10
- **ブザー**: ピン12
- **バッテリー監視**: A7

### 3. キャリブレーション

1. Arduinoにプログラムをアップロード
2. シリアルモニターを開く（115200 baud）
3. バイクを水平な状態に設置
4. シリアルモニターで `c+` を送信してキャリブレーションモードに入る
5. キャリブレーション完了後、`c-` を送信して保存

詳細なキャリブレーション手順は、[角度計算とモーター制御レポート](角度計算とモーター制御レポート.md)を参照してください。

### 4. PIDパラメータの調整

デフォルトのPIDパラメータ：
- K1 (P): 24.00
- K2 (I): -20.00
- K3 (D): -9.00
- K4 (A): -0.00

調整が必要な場合は、シリアルモニターで以下のコマンドを使用：
- `p+` / `p-`: K1を増減
- `i+` / `i-`: K2を増減
- `s+` / `s-`: K3を増減
- `a+` / `a-`: K4を増減

PIDデバッグの詳細は `01.Arduino Code and Library/how to debug PID.txt` を参照してください。

### 5. Androidアプリのインストール

1. `02.APP/app.apk`をAndroid端末に転送
2. アプリをインストール
3. BluetoothまたはUSB経由でArduinoと接続

## 動作原理

### 角度検出

MPU6050センサーから加速度計とジャイロのデータを取得し、補完フィルタ（Complementary Filter）を使用してロボットの傾き角度を計算します。

- **加速度計**: 重力ベクトルから角度を直接計算（低周波数で正確）
- **ジャイロ**: 角速度を積分して角度を計算（高周波数で正確）
- **補完フィルタ**: 両者の長所を組み合わせて安定した角度を算出

詳細は[角度計算とモーター制御レポート](角度計算とモーター制御レポート.md)を参照してください。

### PID制御

以下の4つの要素からモーターのPWM値を計算します：

```
PWM = K1 × robot_angle + K2 × gyroXfilt + K3 × motor_speed + K4 × motor_pos
```

- **K1 × robot_angle**: 角度偏差に対する比例応答
- **K2 × gyroXfilt**: 角速度フィードバック（ローパスフィルタ適用済み）
- **K3 × motor_speed**: 速度フィードバック（エンコーダーから取得）
- **K4 × motor_pos**: 位置フィードバック（現在は0で無効）

### 制御ループ

メイン制御ループは10ms周期で実行されます：

1. リモート制御パラメータの読み取り
2. MPU6050からの角度計算
3. エンコーダーからの速度取得
4. PID制御値の計算
5. モーターとサーボの制御

詳細は[self_balancing_bike.ino説明書](self_balancing_bike.ino説明書.md)を参照してください。

## ドキュメント

このプロジェクトには以下の詳細ドキュメントが含まれています：

1. **[self_balancing_bike.ino説明書](self_balancing_bike.ino説明書.md)**
   - メインプログラムの詳細な説明
   - ピン定義、変数、関数の説明
   - setup()とloop()の動作説明

2. **[角度計算とモーター制御レポート](角度計算とモーター制御レポート.md)**
   - MPU6050センサーの詳細説明
   - 補完フィルタの動作原理
   - 角度計算アルゴリズム
   - モーター制御の仕組み
   - 起動時のキャリブレーション手順
   - バランス状態の管理と安全機能

3. **[self_balancing_bike.ino、functions.ino、remote.inoの関係](self_balancing_bike.ino、functions.ino、remote.inoの関係.md)**
   - 3つのファイル間の関係
   - 関数の呼び出し関係
   - グローバル変数の共有
   - データフロー図

## 安全機能

- **動作条件チェック**: 垂直状態（±0.3度以内）かつキャリブレーション済みの場合のみ動作
- **自動停止**: 角度が±10度を超えた場合、自動的にモーターを停止
- **バッテリー監視**: 2秒周期でバッテリー電圧を監視し、低電圧時に警告
- **ブレーキ制御**: 動作条件を満たさない場合、ブレーキを解放

## トラブルシューティング

### バイクがバランスを取れない

1. キャリブレーションが正しく行われているか確認
2. PIDパラメータを調整（`how to debug PID.txt`を参照）
3. MPU6050の接続を確認
4. モーターとエンコーダーの接続を確認

### リモート制御が動作しない

1. Androidアプリが正しくインストールされているか確認
2. Bluetooth/USB接続を確認
3. シリアル通信のボーレートが115200に設定されているか確認

### 起動時にビープ音が2回鳴る

- **1回目**: 起動準備完了（setup()関数内）
- **2回目**: ジャイロオフセット補正完了（angle_setup()関数内）

これは正常な動作です。詳細は[角度計算とモーター制御レポート](角度計算とモーター制御レポート.md)を参照してください。

## ライセンス

このプロジェクトはオープンソースとして公開されています。詳細は各ファイルのライセンス情報を確認してください。

## 貢献

バグ報告や機能改善の提案は、IssueまたはPull Requestでお願いします。

## 謝辞

このプロジェクトのArduinoコードは、以下のオープンソースプロジェクトを基にしています：

- **[remrc/Self-Balancing-Bike](https://github.com/remrc/Self-Balancing-Bike)** - 元のセルフバランシングバイクプロジェクト
  - Arduino Nano、Nidec 24Hモーター、MPU6050を使用したセルフバランシングバイク
  - Bluetooth経由でのリモート制御とPIDパラメータ調整機能

元の開発者である[remrc](https://github.com/remrc)氏に感謝いたします。

---

**注意**: このプロジェクトは実験的なものです。実際に使用する際は、安全に十分注意してください。

